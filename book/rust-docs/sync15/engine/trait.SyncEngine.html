<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="A “sync engine” is a thing that knows how to sync. It’s often implemented by a “store” (which is the generic term responsible for all storage associated with a component, including storage required for sync.)"><meta name="keywords" content="rust, rustlang, rust-lang, SyncEngine"><title>SyncEngine in sync15::engine - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Regular-1f7d512b176f0f72.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Bold-124a1ca42af929b6.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-93196c7a1c3542a8.css" id="mainThemeStyle"><link rel="stylesheet" id="themeStyle" href="../../static.files/light-4743e13df3dfe8c4.css"><link rel="stylesheet" disabled href="../../static.files/dark-0e1b889528bd466b.css"><link rel="stylesheet" disabled href="../../static.files/ayu-65289d5d067c7c66.css"><script id="default-settings" ></script><script src="../../static.files/storage-d43fa987303ecbbb.js"></script><script defer src="sidebar-items.js"></script><script defer src="../../static.files/main-3367e395607fafc1.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc trait"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../sync15/index.html"><img class="rust-logo" src="../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../sync15/index.html"><img class="rust-logo" src="../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">SyncEngine</a></h2><div class="sidebar-elems"><section><h3><a href="#required-methods">Required Methods</a></h3><ul class="block"><li><a href="#tymethod.apply_incoming">apply_incoming</a></li><li><a href="#tymethod.collection_name">collection_name</a></li><li><a href="#tymethod.get_collection_requests">get_collection_requests</a></li><li><a href="#tymethod.get_sync_assoc">get_sync_assoc</a></li><li><a href="#tymethod.reset">reset</a></li><li><a href="#tymethod.sync_finished">sync_finished</a></li><li><a href="#tymethod.wipe">wipe</a></li></ul><h3><a href="#provided-methods">Provided Methods</a></h3><ul class="block"><li><a href="#method.prepare_for_sync">prepare_for_sync</a></li><li><a href="#method.set_local_encryption_key">set_local_encryption_key</a></li></ul><h3><a href="#implementors">Implementors</a></h3></section><h2><a href="index.html">In sync15::engine</a></h2></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../static.files/wheel-5ec35bf9ca753509.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Trait <a href="../index.html">sync15</a>::<wbr><a href="index.html">engine</a>::<wbr><a class="trait" href="#">SyncEngine</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../src/sync15/engine/sync_engine.rs.html#106-203">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><div class="item-decl"><pre class="rust"><code>pub trait SyncEngine {
    fn <a href="#tymethod.collection_name" class="fn">collection_name</a>(&amp;self) -&gt; <a class="type" href="../type.CollectionName.html" title="type sync15::CollectionName">CollectionName</a>;
<span class="item-spacer"></span>    fn <a href="#tymethod.apply_incoming" class="fn">apply_incoming</a>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;self,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inbound: <a class="struct" href="https://doc.rust-lang.org/1.68.0/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="struct.IncomingChangeset.html" title="struct sync15::engine::IncomingChangeset">IncomingChangeset</a>&gt;,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;telem: &amp;mut <a class="struct" href="../telemetry/struct.Engine.html" title="struct sync15::telemetry::Engine">Engine</a><br>&nbsp;&nbsp;&nbsp;&nbsp;) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="struct" href="struct.OutgoingChangeset.html" title="struct sync15::engine::OutgoingChangeset">OutgoingChangeset</a>&gt;;
<span class="item-spacer"></span>    fn <a href="#tymethod.sync_finished" class="fn">sync_finished</a>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;self,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_timestamp: <a class="struct" href="../struct.ServerTimestamp.html" title="struct sync15::ServerTimestamp">ServerTimestamp</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;records_synced: <a class="struct" href="https://doc.rust-lang.org/1.68.0/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../struct.Guid.html" title="struct sync15::Guid">Guid</a>&gt;<br>&nbsp;&nbsp;&nbsp;&nbsp;) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.68.0/std/primitive.unit.html">()</a>&gt;;
<span class="item-spacer"></span>    fn <a href="#tymethod.get_collection_requests" class="fn">get_collection_requests</a>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;self,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_timestamp: <a class="struct" href="../struct.ServerTimestamp.html" title="struct sync15::ServerTimestamp">ServerTimestamp</a><br>&nbsp;&nbsp;&nbsp;&nbsp;) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/1.68.0/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="struct.CollectionRequest.html" title="struct sync15::engine::CollectionRequest">CollectionRequest</a>&gt;&gt;;
<span class="item-spacer"></span>    fn <a href="#tymethod.get_sync_assoc" class="fn">get_sync_assoc</a>(&amp;self) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="enum" href="enum.EngineSyncAssociation.html" title="enum sync15::engine::EngineSyncAssociation">EngineSyncAssociation</a>&gt;;
<span class="item-spacer"></span>    fn <a href="#tymethod.reset" class="fn">reset</a>(&amp;self, assoc: &amp;<a class="enum" href="enum.EngineSyncAssociation.html" title="enum sync15::engine::EngineSyncAssociation">EngineSyncAssociation</a>) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.68.0/std/primitive.unit.html">()</a>&gt;;
<span class="item-spacer"></span>    fn <a href="#tymethod.wipe" class="fn">wipe</a>(&amp;self) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.68.0/std/primitive.unit.html">()</a>&gt;;

    fn <a href="#method.prepare_for_sync" class="fn">prepare_for_sync</a>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;self,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_get_client_data: &amp;dyn <a class="trait" href="https://doc.rust-lang.org/1.68.0/core/ops/function/trait.Fn.html" title="trait core::ops::function::Fn">Fn</a>() -&gt; <a class="struct" href="../struct.ClientData.html" title="struct sync15::ClientData">ClientData</a><br>&nbsp;&nbsp;&nbsp;&nbsp;) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.68.0/std/primitive.unit.html">()</a>&gt; { ... }
<span class="item-spacer"></span>    fn <a href="#method.set_local_encryption_key" class="fn">set_local_encryption_key</a>(&amp;mut self, _key: &amp;<a class="primitive" href="https://doc.rust-lang.org/1.68.0/std/primitive.str.html">str</a>) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.68.0/std/primitive.unit.html">()</a>&gt; { ... }
}</code></pre></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>A “sync engine” is a thing that knows how to sync. It’s often implemented
by a “store” (which is the generic term responsible for all storage
associated with a component, including storage required for sync.)</p>
<p>Low-level engine functionality. Engines that need custom reconciliation
logic should use this.</p>
<p>Different engines will produce errors of different types.  To accommodate
this, we force them all to return anyhow::Error.</p>
</div></details><h2 id="required-methods" class="small-section-header">Required Methods<a href="#required-methods" class="anchor">§</a></h2><div class="methods"><section id="tymethod.collection_name" class="method has-srclink"><a class="srclink rightside" href="../../src/sync15/engine/sync_engine.rs.html#107">source</a><h4 class="code-header">fn <a href="#tymethod.collection_name" class="fn">collection_name</a>(&amp;self) -&gt; <a class="type" href="../type.CollectionName.html" title="type sync15::CollectionName">CollectionName</a></h4></section><details class="toggle method-toggle" open><summary><section id="tymethod.apply_incoming" class="method has-srclink"><a class="srclink rightside" href="../../src/sync15/engine/sync_engine.rs.html#158-162">source</a><h4 class="code-header">fn <a href="#tymethod.apply_incoming" class="fn">apply_incoming</a>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&amp;self,<br>&nbsp;&nbsp;&nbsp;&nbsp;inbound: <a class="struct" href="https://doc.rust-lang.org/1.68.0/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="struct.IncomingChangeset.html" title="struct sync15::engine::IncomingChangeset">IncomingChangeset</a>&gt;,<br>&nbsp;&nbsp;&nbsp;&nbsp;telem: &amp;mut <a class="struct" href="../telemetry/struct.Engine.html" title="struct sync15::telemetry::Engine">Engine</a><br>) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="struct" href="struct.OutgoingChangeset.html" title="struct sync15::engine::OutgoingChangeset">OutgoingChangeset</a>&gt;</h4></section></summary><div class="docblock"><p><code>inbound</code> is a vector to support the case where
<code>get_collection_requests</code> returned multiple requests. The changesets are
in the same order as the requests were – e.g. if <code>vec![req_a, req_b]</code>
was returned from <code>get_collection_requests</code>, <code>inbound</code> will have the
results from <code>req_a</code> as its first index, and those from <code>req_b</code> as it’s
second.</p>
</div></details><section id="tymethod.sync_finished" class="method has-srclink"><a class="srclink rightside" href="../../src/sync15/engine/sync_engine.rs.html#164-168">source</a><h4 class="code-header">fn <a href="#tymethod.sync_finished" class="fn">sync_finished</a>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&amp;self,<br>&nbsp;&nbsp;&nbsp;&nbsp;new_timestamp: <a class="struct" href="../struct.ServerTimestamp.html" title="struct sync15::ServerTimestamp">ServerTimestamp</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;records_synced: <a class="struct" href="https://doc.rust-lang.org/1.68.0/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="../struct.Guid.html" title="struct sync15::Guid">Guid</a>&gt;<br>) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.68.0/std/primitive.unit.html">()</a>&gt;</h4></section><details class="toggle method-toggle" open><summary><section id="tymethod.get_collection_requests" class="method has-srclink"><a class="srclink rightside" href="../../src/sync15/engine/sync_engine.rs.html#188-191">source</a><h4 class="code-header">fn <a href="#tymethod.get_collection_requests" class="fn">get_collection_requests</a>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&amp;self,<br>&nbsp;&nbsp;&nbsp;&nbsp;server_timestamp: <a class="struct" href="../struct.ServerTimestamp.html" title="struct sync15::ServerTimestamp">ServerTimestamp</a><br>) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/1.68.0/alloc/vec/struct.Vec.html" title="struct alloc::vec::Vec">Vec</a>&lt;<a class="struct" href="struct.CollectionRequest.html" title="struct sync15::engine::CollectionRequest">CollectionRequest</a>&gt;&gt;</h4></section></summary><div class="docblock"><p>The engine is responsible for building collection requests. Engines
typically will store a lastModified timestamp and use that to build a
request saying “give me full records since that date” - however, other
engines might do something fancier. This could even later be extended to
handle “backfills” etc</p>
<p>To support more advanced use cases,  multiple requests can be returned
here - either from the same or different collections. The vast majority
of engines will just want to return zero or one item in their vector
(zero is a valid optimization when the server timestamp is the same as
the engine last saw, one when it is not)</p>
<p>Important: In the case when more than one collection is requested, it’s
assumed the last one is the “canonical” one. (That is, it must be for
“this” collection, its timestamp is used to represent the sync, etc).
(Note that multiple collection request support is currently unused, so
it might make sense to delete it - if we need it later, we may find a
better shape for our use-case)</p>
</div></details><details class="toggle method-toggle" open><summary><section id="tymethod.get_sync_assoc" class="method has-srclink"><a class="srclink rightside" href="../../src/sync15/engine/sync_engine.rs.html#195">source</a><h4 class="code-header">fn <a href="#tymethod.get_sync_assoc" class="fn">get_sync_assoc</a>(&amp;self) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="enum" href="enum.EngineSyncAssociation.html" title="enum sync15::engine::EngineSyncAssociation">EngineSyncAssociation</a>&gt;</h4></section></summary><div class="docblock"><p>Get persisted sync IDs. If they don’t match the global state we’ll be
<code>reset()</code> with the new IDs.</p>
</div></details><details class="toggle method-toggle" open><summary><section id="tymethod.reset" class="method has-srclink"><a class="srclink rightside" href="../../src/sync15/engine/sync_engine.rs.html#200">source</a><h4 class="code-header">fn <a href="#tymethod.reset" class="fn">reset</a>(&amp;self, assoc: &amp;<a class="enum" href="enum.EngineSyncAssociation.html" title="enum sync15::engine::EngineSyncAssociation">EngineSyncAssociation</a>) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.68.0/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Reset the engine (and associated store) without wiping local data,
ready for a “first sync”.
<code>assoc</code> defines how this store is to be associated with sync.</p>
</div></details><section id="tymethod.wipe" class="method has-srclink"><a class="srclink rightside" href="../../src/sync15/engine/sync_engine.rs.html#202">source</a><h4 class="code-header">fn <a href="#tymethod.wipe" class="fn">wipe</a>(&amp;self) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.68.0/std/primitive.unit.html">()</a>&gt;</h4></section></div><h2 id="provided-methods" class="small-section-header">Provided Methods<a href="#provided-methods" class="anchor">§</a></h2><div class="methods"><details class="toggle method-toggle" open><summary><section id="method.prepare_for_sync" class="method has-srclink"><a class="srclink rightside" href="../../src/sync15/engine/sync_engine.rs.html#122-124">source</a><h4 class="code-header">fn <a href="#method.prepare_for_sync" class="fn">prepare_for_sync</a>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&amp;self,<br>&nbsp;&nbsp;&nbsp;&nbsp;_get_client_data: &amp;dyn <a class="trait" href="https://doc.rust-lang.org/1.68.0/core/ops/function/trait.Fn.html" title="trait core::ops::function::Fn">Fn</a>() -&gt; <a class="struct" href="../struct.ClientData.html" title="struct sync15::ClientData">ClientData</a><br>) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.68.0/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Prepares the engine for syncing. The tabs engine currently uses this to
store the current list of clients, which it uses to look up device names
and types.</p>
<p>Note that this method is only called by <code>sync_multiple</code>, and only if a
command processor is registered. In particular, <code>prepare_for_sync</code> will
not be called if the store is synced using <code>sync::synchronize</code> or
<code>sync_multiple::sync_multiple</code>. It <em>will</em> be called if the store is
synced via the Sync Manager.</p>
<p>TODO(issue #2590): This is pretty cludgey and will be hard to extend for
any case other than the tabs case. We should find another way to support
tabs…</p>
</div></details><details class="toggle method-toggle" open><summary><section id="method.set_local_encryption_key" class="method has-srclink"><a class="srclink rightside" href="../../src/sync15/engine/sync_engine.rs.html#148-150">source</a><h4 class="code-header">fn <a href="#method.set_local_encryption_key" class="fn">set_local_encryption_key</a>(&amp;mut self, _key: &amp;<a class="primitive" href="https://doc.rust-lang.org/1.68.0/std/primitive.str.html">str</a>) -&gt; <a class="type" href="https://docs.rs/anyhow/1.0.58/anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.68.0/std/primitive.unit.html">()</a>&gt;</h4></section></summary><div class="docblock"><p>Tells the engine what the local encryption key is for the data managed
by the engine. This is only used by collections that store data
encrypted locally and is unrelated to the encryption used by Sync.
The intent is that for such collections, this key can be used to
decrypt local data before it is re-encrypted by Sync and sent to the
storage servers, and similarly, data from the storage servers will be
decrypted by Sync, then encrypted by the local encryption key before
being added to the local database.</p>
<p>The expectation is that the key value is being maintained by the
embedding application in some secure way suitable for the environment
in which the app is running - eg, the OS “keychain”. The value of the
key is implementation dependent - it is expected that the engine and
embedding application already have some external agreement about how
to generate keys and in what form they are exchanged. Finally, there’s
an assumption that sync engines are short-lived and only live for a
single sync - this means that sync doesn’t hold on to the key for an
extended period.</p>
<p>This will panic if called by an engine that doesn’t have explicit
support for local encryption keys as that implies a degree of confusion
which shouldn’t be possible to ignore.</p>
</div></details></div><h2 id="implementors" class="small-section-header">Implementors<a href="#implementors" class="anchor">§</a></h2><div id="implementors-list"></div><script src="../../implementors/sync15/engine/sync_engine/trait.SyncEngine.js" async></script></section></div></main><div id="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="sync15" data-themes="" data-resource-suffix="" data-rustdoc-version="1.68.0 (2c8cc3432 2023-03-06)" data-search-js="search-98d53477a794af0b.js" data-settings-js="settings-c3c521c753752a1a.js" data-settings-css="settings-08ddfdda51b8ee2e.css" ></div></body></html>